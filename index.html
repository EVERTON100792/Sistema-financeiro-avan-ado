<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Financeiro Avançado</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>

    <style>
        /* CSS inalterado - O mesmo da versão anterior */
        :root {
            --bg-color: #1a1a2e; --primary-color: #16213e; --secondary-color: #0f3460;
            --accent-color: #e94560; --text-color: #ffffff; --text-muted-color: #a0a0b0;
            --success-color: #2ecc71; --error-color: #e74c3c; --warning-color: #f1c40f;
            --card-bg-color: #1e1e3f; --border-radius: 12px; --box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
            --font-family: 'Poppins', sans-serif;
        }
        body.light-mode {
            --bg-color: #f4f7fc; --primary-color: #ffffff; --secondary-color: #eef2f9;
            --accent-color: #3b82f6; --text-color: #1f2937; --text-muted-color: #6b7280;
            --card-bg-color: #ffffff; --box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: var(--font-family); }
        body { background-color: var(--bg-color); color: var(--text-color); transition: background-color 0.3s, color 0.3s; overflow-x: hidden; line-height: 1.6; }
        .container { padding: 20px; max-width: 1400px; margin: 0 auto; animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .card { background-color: var(--card-bg-color); padding: 25px; border-radius: var(--border-radius); box-shadow: var(--box-shadow); transition: background-color 0.3s; position: relative; }
        h1, h2, h3 { color: var(--text-color); transition: color 0.3s; }
        h2 { margin-bottom: 20px; border-bottom: 1px solid var(--secondary-color); padding-bottom: 10px; }
        .btn { padding: 10px 20px; border: none; border-radius: var(--border-radius); cursor: pointer; font-weight: 600; transition: transform 0.2s, background-color 0.2s, box-shadow 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.15); }
        .btn-primary { background-color: var(--accent-color); color: white; }
        .btn-secondary { background-color: var(--secondary-color); color: var(--text-color); }
        .btn-success { background-color: var(--success-color); color: white; }
        .btn-danger { background-color: var(--error-color); color: white; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; color: var(--text-muted-color); font-weight: 500; }
        .form-group input, .form-group select { width: 100%; padding: 12px; border-radius: var(--border-radius); border: 1px solid var(--secondary-color); background-color: var(--primary-color); color: var(--text-color); font-size: 0.95rem; transition: all 0.3s; }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: var(--accent-color); box-shadow: 0 0 0 3px color-mix(in srgb, var(--accent-color) 20%, transparent); }
        .form-group input:disabled, .form-group select:disabled { background-color: var(--secondary-color); cursor: not-allowed; opacity: 0.7; }
        .form-buttons { display: flex; gap: 10px; }
        .form-buttons .btn { flex-grow: 1; }
        #login-container { display: flex; justify-content: center; align-items: center; height: 100vh; background: linear-gradient(135deg, var(--bg-color) 0%, var(--primary-color) 100%); }
        .login-box { text-align: center; width: 90%; max-width: 400px; animation: fadeIn 0.5s; }
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px; }
        .header-actions { display: flex; align-items: center; gap: 15px; }
        #theme-toggle { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-muted-color); transition: transform 0.2s; }
        #theme-toggle:hover { transform: scale(1.1); }
        nav.tabs { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .tab-btn { padding: 10px 20px; border: none; border-bottom: 3px solid transparent; border-radius: 8px 8px 0 0; background-color: transparent; color: var(--text-muted-color); font-weight: 500; cursor: pointer; transition: all 0.3s; }
        .tab-btn:hover { color: var(--text-color); background-color: var(--secondary-color); }
        .tab-btn.active { color: var(--accent-color); font-weight: 600; border-bottom-color: var(--accent-color); }
        .tab-content { display: none; animation: fadeIn 0.4s; }
        .tab-content.active { display: block; }
        .summary-section { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .summary-card .amount { font-size: 2rem; font-weight: 600; }
        #balance.positive { color: var(--success-color); }
        #balance.negative { color: var(--error-color); }
        #total-income { color: var(--success-color); }
        #total-expense { color: var(--error-color); }
        .dashboard-layout { display: grid; grid-template-columns: 1fr; gap: 30px; }
        @media (min-width: 992px) { .dashboard-layout { grid-template-columns: 380px 1fr; } }
        #main-overview-chart-container, #evolution-chart-container { min-height: 400px; position: relative; }
        .filters-and-actions { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 15px; align-items: center; }
        .filters-and-actions .form-group { margin-bottom: 0; flex-grow: 1; }
        #transaction-list, #categories-list { list-style: none; max-height: 400px; overflow-y: auto; padding-right: 10px; }
        .transaction-item, .category-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; background-color: var(--primary-color); border-radius: var(--border-radius); margin-bottom: 10px; flex-wrap: wrap; gap: 10px; transition: opacity 0.3s, background-color 0.3s; }
        .transaction-item { border-left: 5px solid; }
        .transaction-item.income { border-left-color: var(--success-color); }
        .transaction-item.expense { border-left-color: var(--error-color); }
        .transaction-item.transfer { border-left-color: var(--accent-color); }
        .transaction-item.due-soon { border-left-color: var(--warning-color) !important; background-color: color-mix(in srgb, var(--primary-color) 80%, var(--warning-color) 20%); }
        .transaction-item.overdue { border-left-color: var(--error-color) !important; background-color: color-mix(in srgb, var(--primary-color) 80%, var(--error-color) 20%); }
        body.light-mode .transaction-item.due-soon { background-color: #fffbe6; }
        body.light-mode .transaction-item.overdue { background-color: #ffeef0; }
        .transaction-item.paid { opacity: 0.7; }
        .transaction-item .info .description { font-weight: 500; }
        .transaction-item .info .details { display: flex; flex-wrap: wrap; gap: 10px; font-size: 0.8rem; color: var(--text-muted-color); margin-top: 5px; }
        .transaction-item .info .details .details-tag { background-color: var(--secondary-color); padding: 2px 8px; border-radius: 5px; }
        .transaction-item .info .details .paid-tag { background-color: var(--success-color); color: white; font-weight: bold; }
        .transaction-item.due-soon .info .details .due-date-tag { background-color: var(--warning-color); color: #1f2937; font-weight: 500;}
        .transaction-item.overdue .info .details .due-date-tag { background-color: var(--error-color); color: white; }
        .transaction-item .amount { font-weight: 600; font-size: 1.1rem; }
        .transaction-item .amount.income { color: var(--success-color); }
        .transaction-item .amount.expense { color: var(--error-color); }
        .transaction-item .amount.transfer { color: var(--accent-color); }
        .progress-bar-container { width: 100%; background-color: var(--secondary-color); border-radius: var(--border-radius); overflow: hidden; margin-top: 5px; }
        .progress-bar { height: 15px; background-color: var(--accent-color); border-radius: var(--border-radius); width: 0; transition: width 0.5s; text-align: center; color: white; font-size: 0.7rem; line-height: 15px; }
        .progress-bar.over { background-color: var(--error-color); }
        .goal-contribution-form { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--secondary-color); }
        .goal-contribution-form input, .goal-contribution-form select { flex-grow: 1; width: auto; }
        .goal-contribution-form .btn { flex-shrink: 0; }
        .grid-layout { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; }
        .single-form-layout { max-width: 500px; margin: 0 auto; }
        .list-item { display: flex; flex-direction: column; background-color: var(--primary-color); padding: 15px; border-radius: var(--border-radius); margin-bottom: 10px; transition: background-color 0.3s, opacity 0.3s; }
        .list-item-header { display: flex; justify-content: space-between; align-items: flex-start; width: 100%; }
        .list-item .main-info { flex-grow: 1; }
        .actions { display: flex; align-items: center; gap: 8px; position: relative; }
        .actions button { background: none; border: none; cursor: pointer; color: var(--text-muted-color); padding: 5px; font-size: 1rem; display: inline-flex; align-items: center; justify-content: center; }
        .actions button:hover { color: var(--accent-color); }
        .delete-button { background-color: var(--error-color) !important; color: white !important; border-radius: 50%; width: 28px; height: 28px; }
        .delete-button:hover { background-color: #c0392b !important; }
        #transaction-form-blocker { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.7); color: white; display: flex; justify-content: center; align-items: center; text-align: center; padding: 20px; border-radius: var(--border-radius); z-index: 10; backdrop-filter: blur(5px); transition: opacity 0.3s, visibility 0.3s; }
        #transaction-form-blocker.hidden { opacity: 0; visibility: hidden; }
        ::-webkit-scrollbar { width: 8px; } ::-webkit-scrollbar-track { background: var(--primary-color); }
        ::-webkit-scrollbar-thumb { background: var(--secondary-color); border-radius: 10px; } ::-webkit-scrollbar-thumb:hover { background: var(--accent-color); }
    </style>
</head>
<body>

    <div id="login-container">
        <div class="login-box card">
            <h1>Acesso Seguro</h1>
            <p style="margin-bottom: 20px; color: var(--text-muted-color);">Para começar, digite seu nome. Seus dados serão salvos localmente no seu navegador.</p>
            <div class="form-group">
                <input type="text" id="username" placeholder="Digite seu nome de usuário" required>
            </div>
            <button id="login-btn" class="btn btn-primary" style="width: 100%;">Entrar</button>
        </div>
    </div>

    <div id="app-container" style="display: none;" class="container">
        <header>
            <h1 id="welcome-message">Painel Financeiro</h1>
            <div class="header-actions">
                <button id="theme-toggle" title="Alterar Tema">🌙</button>
                <button id="logout-btn" class="btn btn-secondary">Sair</button>
            </div>
        </header>

        <nav class="tabs">
            <button class="tab-btn active" data-tab="dashboard">Painel</button>
            <button class="tab-btn" data-tab="accounts">Contas</button>
            <button class="tab-btn" data-tab="categories">Categorias</button>
            <button class="tab-btn" data-tab="transfers">Transferências</button>
            <button class="tab-btn" data-tab="budgets">Orçamentos</button>
            <button class="tab-btn" data-tab="goals">Metas</button>
            <button class="tab-btn" data-tab="recurrences">Recorrências</button>
        </nav>

        <main>
            <div id="tab-dashboard" class="tab-content active">
                <section class="summary-section">
                    <div class="summary-card card">
                        <h3>Patrimônio Líquido</h3>
                        <span id="balance" class="amount">R$ 0,00</span>
                    </div>
                    <div class="summary-card card">
                        <h3>Receitas (Mês)</h3>
                        <span id="total-income" class="amount">R$ 0,00</span>
                    </div>
                    <div class="summary-card card">
                        <h3>Despesas Pagas (Mês)</h3>
                        <span id="total-expense" class="amount">R$ 0,00</span>
                    </div>
                </section>
                
                <section class="card" style="margin-bottom: 30px;">
                    <h2>Visão Geral do Mês</h2>
                    <div id="main-overview-chart-container">
                        <canvas id="main-overview-chart"></canvas>
                    </div>
                </section>
                
                <div class="dashboard-layout">
                    <aside class="card">
                        <div id="transaction-form-blocker">
                            <div>
                                <h3>Primeiro Passo</h3>
                                <p>Cadastre uma conta na aba "Contas" para poder adicionar transações.</p>
                            </div>
                        </div>
                        <h2 id="transaction-form-title">Nova Transação</h2>
                        <form id="transaction-form">
                             <div class="form-group">
                                 <label for="transaction-type">Tipo</label>
                                 <select id="transaction-type" required>
                                     <option value="expense">Despesa</option>
                                     <option value="income">Receita</option>
                                 </select>
                             </div>
                            <div class="form-group">
                                <label for="description">Descrição</label>
                                <input type="text" id="description" placeholder="Ex: Aluguel, Salário" required>
                            </div>
                            <div class="form-group">
                                <label for="amount">Valor (R$)</label>
                                <input type="number" id="amount" step="0.01" placeholder="150.50" required>
                            </div>
                            <div class="form-group">
                                <label for="date">Data da Transação</label>
                                <input type="date" id="date" required>
                            </div>
                            <div class="form-group" id="account-from-group">
                                <label for="account-select" id="account-from-label">Conta / Cartão</label>
                                <select id="account-select" required></select>
                            </div>
                            <div class="form-group" id="category-group">
                                <label for="category-select">Categoria</label>
                                <select id="category-select" required></select>
                            </div>
                            <div class="form-group" id="due-date-group">
                                <label for="due-date">Data de Vencimento</label>
                                <input type="date" id="due-date">
                            </div>

                            <div class="form-group" id="make-recurring-group" style="display: none;">
                                <label for="make-recurring-checkbox" style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                    <input type="checkbox" id="make-recurring-checkbox" style="width: auto;">
                                    <span>Tornar esta despesa recorrente (mensal)</span>
                                </label>
                            </div>
                            <div class="form-buttons" id="transaction-form-buttons">
                                <button type="submit" id="add-transaction-btn" class="btn btn-primary">Adicionar Transação</button>
                            </div>
                        </form>
                    </aside>
                    <section class="card">
                        <h2>Histórico de Transações</h2>
                        <div class="filters-and-actions">
                            <div class="form-group"> <select id="date-filter"> <option value="all">Todo o Período</option> <option value="7">Últimos 7 dias</option> <option value="30">Últimos 30 dias</option> <option value="month">Este Mês</option> </select> </div>
                            <div class="form-group"> <select id="category-filter"></select> </div>
                            <div class="form-group"> <select id="payment-status-filter"> <option value="all">Todos os Status</option> <option value="paid">Pagas</option> <option value="unpaid">A Pagar</option> </select> </div>
                            <button id="export-csv" class="btn btn-secondary">CSV</button>
                            <button id="export-pdf" class="btn btn-secondary">PDF</button>
                        </div>
                        <ul id="transaction-list"></ul>
                    </section>
                </div>
                <section class="card" style="margin-top: 30px;">
                    <h2>Evolução do Patrimônio</h2>
                    <div id="evolution-chart-container">
                        <canvas id="evolution-chart"></canvas>
                    </div>
                </section>
            </div>

            <div id="tab-accounts" class="tab-content">
                <div class="grid-layout">
                    <div class="card">
                        <h2 id="account-form-title">Adicionar Conta/Cartão</h2>
                        <form id="account-form">
                            <div class="form-group"> <label for="account-name">Nome da Conta/Cartão</label> <input type="text" id="account-name" placeholder="Ex: Banco do Brasil, Nubank" required> </div>
                            <div class="form-group"> <label for="account-type">Tipo</label> <select id="account-type" required> <option value="checking">Conta Corrente</option> <option value="savings">Poupança</option> <option value="cash">Dinheiro</option> <option value="credit_card">Cartão de Crédito</option> </select> </div>
                            <div class="form-group"> <label for="initial-balance" id="initial-balance-label">Saldo Inicial</label> <input type="number" id="initial-balance" step="0.01" value="0" required> </div>
                            <div class="form-buttons" id="account-form-buttons"> <button type="submit" class="btn btn-primary">Salvar Conta</button> </div>
                        </form>
                    </div>
                    <div class="card">
                        <h2>Minhas Contas</h2>
                        <div id="accounts-list"></div>
                    </div>
                </div>
            </div>

            <div id="tab-categories" class="tab-content">
                <div class="grid-layout">
                    <div class="card">
                        <h2 id="category-form-title">Adicionar Categoria</h2>
                        <form id="category-form">
                           <div class="form-group"> <label for="category-name">Nome da Categoria</label> <input type="text" id="category-name" placeholder="Ex: Supermercado" required> </div>
                            <div class="form-buttons" id="category-form-buttons"> <button type="submit" class="btn btn-primary">Adicionar Categoria</button> </div>
                        </form>
                    </div>
                    <div class="card">
                        <h2>Minhas Categorias</h2>
                        <div id="categories-list"></div>
                    </div>
                </div>
            </div>

            <div id="tab-transfers" class="tab-content">
                <div class="single-form-layout">
                    <div class="card">
                        <h2>Nova Transferência</h2>
                        <form id="transfer-form">
                            <div class="form-group"> <label for="transfer-amount">Valor (R$)</label> <input type="number" id="transfer-amount" step="0.01" placeholder="100.00" required> </div>
                            <div class="form-group"> <label for="transfer-date">Data da Transferência</label> <input type="date" id="transfer-date" required> </div>
                            <div class="form-group"> <label for="transfer-from-account">Da Conta (Origem)</label> <select id="transfer-from-account" required></select> </div>
                            <div class="form-group"> <label for="transfer-to-account">Para a Conta (Destino)</label> <select id="transfer-to-account" required></select> </div>
                            <div class="form-group"> <label for="transfer-description">Descrição (Opcional)</label> <input type="text" id="transfer-description" placeholder="Ex: Mover para poupança"> </div>
                            <div class="form-buttons" id="transfer-form-buttons"> <button type="submit" class="btn btn-primary">Realizar Transferência</button> </div>
                        </form>
                    </div>
                </div>
            </div>

            <div id="tab-budgets" class="tab-content">
                   <div class="grid-layout">
                     <div class="card">
                         <h2 id="budget-form-title">Definir Orçamento</h2>
                         <form id="budget-form">
                             <div class="form-group"> <label for="budget-category">Categoria</label> <select id="budget-category" required></select> </div>
                             <div class="form-group"> <label for="budget-amount">Limite Mensal (R$)</label> <input type="number" id="budget-amount" step="0.01" placeholder="500.00" required> </div>
                             <div class="form-buttons" id="budget-form-buttons"> <button type="submit" class="btn btn-primary">Salvar Orçamento</button> </div>
                         </form>
                     </div>
                     <div class="card">
                         <h2>Acompanhamento dos Orçamentos</h2>
                         <div id="budgets-list"></div>
                     </div>
                 </div>
            </div>

            <div id="tab-goals" class="tab-content">
                <div class="grid-layout">
                    <div class="card">
                        <h2 id="goal-form-title">Criar Nova Meta</h2>
                        <form id="goal-form">
                            <div class="form-group"> <label for="goal-name">Nome da Meta</label> <input type="text" id="goal-name" placeholder="Ex: Viagem para a Europa" required> </div>
                            <div class="form-group"> <label for="goal-target">Valor Alvo (R$)</label> <input type="number" id="goal-target" step="0.01" placeholder="10000.00" required> </div>
                            <div class="form-group"> <label for="goal-saved">Valor Já Guardado (R$)</label> <input type="number" id="goal-saved" step="0.01" value="0" required> </div>
                            <div class="form-group"> <label for="goal-deadline">Prazo (Opcional)</label> <input type="date" id="goal-deadline"> </div>
                            <div class="form-buttons" id="goal-form-buttons"> <button type="submit" class="btn btn-primary">Criar Meta</button> </div>
                        </form>
                    </div>
                    <div class="card">
                        <h2>Minhas Metas</h2>
                        <div id="goals-list"></div>
                    </div>
                </div>
            </div>

            <div id="tab-recurrences" class="tab-content">
                <div class="grid-layout">
                    <div class="card">
                        <h2 id="recurrence-form-title">Adicionar Lançamento Recorrente</h2>
                        <form id="recurrence-form">
                            <div class="form-group"> <label for="recurrence-description">Descrição</label> <input type="text" id="recurrence-description" placeholder="Ex: Assinatura Spotify, Aluguel" required> </div>
                            <div class="form-group"> <label for="recurrence-amount">Valor (R$)</label> <input type="number" id="recurrence-amount" step="0.01" required> </div>
                            <div class="form-group"> <label for="recurrence-type">Tipo</label> <select id="recurrence-type" required> <option value="expense">Despesa</option> <option value="income">Receita</option> </select> </div>
                            <div class="form-group"> <label for="recurrence-account">Conta / Cartão</label> <select id="recurrence-account" required></select> </div>
                            <div class="form-group"> <label for="recurrence-category">Categoria</label> <select id="recurrence-category" required></select> </div>
                            <div class="form-group"> <label for="recurrence-frequency">Frequência</label> <select id="recurrence-frequency" required> <option value="monthly">Mensal</option> <option value="weekly">Semanal</option> <option value="yearly">Anual</option> </select> </div>
                            <div class="form-group"> <label for="recurrence-start-date">Data de Início</label> <input type="date" id="recurrence-start-date" required> </div>
                            <div class="form-buttons" id="recurrence-form-buttons"> <button type="submit" class="btn btn-primary">Salvar Recorrência</button> </div>
                        </form>
                    </div>
                    <div class="card">
                        <h2>Meus Lançamentos Recorrentes</h2>
                        <div id="recurrences-list"></div>
                    </div>
                </div>
            </div>
        </main>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {

    const financeApp = {
        elements: {},
        charts: {
            mainOverviewChart: null,
            evolutionChart: null
        },
        state: {
            user: null, 
            transactions: [], 
            accounts: [], 
            budgets: [],
            goals: [], 
            recurrences: [], 
            editingItem: null, 
            categories: [],
        },

        init() {
            this.cacheDOMElements();
            this.addEventListeners();
            this.checkLogin();
        },

        initApp() {
            this.loadData();
            // Inicializa categorias padrão se não houver ou se o formato for antigo
            if (!this.state.categories || this.state.categories.length === 0 || typeof this.state.categories[0] === 'string') {
                   this.state.categories = [
                       { id: 'cat1', name: 'Moradia' }, { id: 'cat2', name: 'Transporte' }, { id: 'cat3', name: 'Alimentação' }, 
                       { id: 'cat4', name: 'Saúde' }, { id: 'cat5', name: 'Lazer' }, { id: 'cat6', name: 'Educação' }, 
                       { id: 'cat7', name: 'Salário' }, { id: 'cat8', name: 'Investimentos' }, { id: 'cat9', name: 'Compras' }, 
                       { id: 'cat10', name: 'Metas' }, { id: 'cat12', name: 'Transferência' }, { id: 'cat11', name: 'Outros' }
                ];
                this.saveData(); // Salva as categorias padrão
            }
            this.generateRecurringTransactions();
            this.applySavedTheme();
            this.elements.welcomeMessage.textContent = `Olá, ${this.state.user}!`;
            document.getElementById('date').valueAsDate = new Date();
            this.initCharts(); // Garante que os gráficos sejam inicializados
            this.handleTransactionTypeChange();
            this.updateAllRenders();
        },
        
        cacheDOMElements() {
            this.elements = {
                loginContainer: document.getElementById('login-container'), appContainer: document.getElementById('app-container'),
                loginBtn: document.getElementById('login-btn'), logoutBtn: document.getElementById('logout-btn'),
                usernameInput: document.getElementById('username'), welcomeMessage: document.getElementById('welcome-message'),
                themeToggle: document.getElementById('theme-toggle'), initialBalanceLabel: document.getElementById('initial-balance-label'),
                accountTypeSelect: document.getElementById('account-type'), dueDateInput: document.getElementById('due-date'),
                dueDateGroup: document.getElementById('due-date-group'), transactionTypeSelect: document.getElementById('transaction-type'),
                tabs: document.querySelectorAll('.tab-btn'), tabContents: document.querySelectorAll('.tab-content'),
                transactionForm: document.getElementById('transaction-form'), transactionFormBlocker: document.getElementById('transaction-form-blocker'),
                makeRecurringGroup: document.getElementById('make-recurring-group'), makeRecurringCheckbox: document.getElementById('make-recurring-checkbox'),
            };
        },

        addEventListeners() {
            this.elements.loginBtn.addEventListener('click', () => this.handleLogin());
            this.elements.usernameInput.addEventListener('keypress', (e) => { if(e.key === 'Enter') this.handleLogin(); });
            this.elements.themeToggle.addEventListener('click', () => this.toggleTheme());
            this.elements.tabs.forEach(tab => tab.addEventListener('click', (e) => this.handleTabClick(e)));
            document.getElementById('transaction-form').addEventListener('submit', (e) => this.handleTransaction(e));
            document.getElementById('account-form').addEventListener('submit', (e) => this.handleAccount(e));
            document.getElementById('budget-form').addEventListener('submit', (e) => this.handleBudget(e));
            document.getElementById('goal-form').addEventListener('submit', (e) => this.handleGoal(e));
            document.getElementById('recurrence-form').addEventListener('submit', (e) => this.handleRecurrence(e));
            document.getElementById('category-form').addEventListener('submit', (e) => this.handleCategorySubmit(e));
            document.getElementById('transfer-form').addEventListener('submit', (e) => this.handleTransfer(e)); 
            document.getElementById('export-csv').addEventListener('click', () => this.exportToCSV());
            document.getElementById('export-pdf').addEventListener('click', () => this.exportToPDF());
            document.getElementById('date-filter').addEventListener('change', () => this.renderTransactions());
            document.getElementById('category-filter').addEventListener('change', () => this.renderTransactions());
            document.getElementById('payment-status-filter').addEventListener('change', () => this.renderTransactions());
            this.elements.transactionTypeSelect.addEventListener('change', () => this.handleTransactionTypeChange());
            this.elements.accountTypeSelect.addEventListener('change', (e) => { this.elements.initialBalanceLabel.textContent = e.target.value === 'credit_card' ? 'Fatura Inicial (R$)' : 'Saldo Inicial (R$)'; });
            this.elements.logoutBtn.addEventListener('click', () => this.handleLogout());
            this.elements.appContainer.addEventListener('click', (e) => {
                const target = e.target;
                const deleteButton = target.closest('.delete-button');
                const payButton = target.closest('.pay-btn');
                const editButton = target.closest('.edit-btn');
                if (editButton) { this.startEditMode(editButton.dataset.type, editButton.dataset.id); }
                if (deleteButton) {
                    const id = deleteButton.dataset.id;
                    const parentListContainer = deleteButton.closest('[id$="-list"]');
                    if (id && parentListContainer) {
                        const listId = parentListContainer.id;
                        if (listId === 'transaction-list') this.deleteTransaction(id);
                        else if (listId === 'accounts-list') this.deleteAccount(id);
                        else if (listId === 'budgets-list') this.deleteBudget(id);
                        else if (listId === 'goals-list') this.deleteGoal(id);
                        else if (listId === 'recurrences-list') this.deleteRecurrence(id);
                        else if (listId === 'categories-list') this.deleteCategory(id);
                    }
                }
                if (payButton) { this.markAsPaid(payButton.dataset.id); }
            });
            document.getElementById('goals-list').addEventListener('submit', (e) => { if (e.target.classList.contains('goal-contribution-form')) { this.handleGoalContribution(e); } });
        },
        
        getDeleteIconSVG() { return `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" width="16" height="16"><path fill-rule="evenodd" d="M8.75 1A2.75 2.75 0 006 3.75v.443c-.795.077-1.58.22-2.365.468a.75.75 0 10.23 1.482l.149-.022.841 10.518A2.75 2.75 0 007.596 19h4.807a2.75 2.75 0 002.742-2.53l.841-10.52.149.023a.75.75 0 00.23-1.482A41.03 41.03 0 0014 4.193V3.75A2.75 2.75 0 0011.25 1h-2.5zM10 4c.84 0 1.673.025 2.5.075V3.75c0-.69-.56-1.25-1.25-1.25h-2.5c-.69 0-1.25.56-1.25 1.25v.325C8.327 4.025 9.16 4 10 4zM8.58 7.72a.75.75 0 00-1.5.06l.3 7.5a.75.75 0 101.5-.06l-.3-7.5zm4.34.06a.75.75 0 10-1.5-.06l-.3 7.5a.75.75 0 101.5.06l.3-7.5z" clip-rule="evenodd" /></svg>`; },
        getEditIconSVG() { return `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" width="16" height="16"><path d="M5.433 13.917l1.262-3.155A4 4 0 017.58 9.42l6.92-6.918a2.121 2.121 0 013 3l-6.92 6.918c-.383.383-.84.685-1.343.886l-3.154 1.262a.5.5 0 01-.65-.65z" /><path d="M3.5 5.75c0-.69.56-1.25 1.25-1.25H10A.75.75 0 0010 3H4.75A2.75 2.75 0 002 5.75v9.5A2.75 2.75 0 004.75 18h9.5A2.75 2.75 0 0017 15.25V10a.75.75 0 00-1.5 0v5.25c0 .69-.56 1.25-1.25 1.25h-9.5c-.69 0-1.25-.56-1.25-1.25v-9.5z" /></svg>`; },
        getStorageKey() { return `financeApp_${this.state.user}`; },
        saveData() { 
            if (!this.state.user) return; 
            try { 
                const dataToSave = { 
                    transactions: this.state.transactions, 
                    accounts: this.state.accounts, 
                    budgets: this.state.budgets, 
                    goals: this.state.goals, 
                    recurrences: this.state.recurrences, 
                    categories: this.state.categories, 
                }; 
                localStorage.setItem(this.getStorageKey(), JSON.stringify(dataToSave)); 
            } catch (error) { 
                console.error("Failed to save data:", error); 
            } 
        },
        loadData() { 
            if (!this.state.user) return; 
            try { 
                const data = localStorage.getItem(this.getStorageKey()); 
                if (data) { 
                    const parsedData = JSON.parse(data); 
                    this.state.transactions = parsedData.transactions || []; 
                    this.state.accounts = parsedData.accounts || []; 
                    this.state.budgets = parsedData.budgets || []; 
                    this.state.goals = parsedData.goals || []; 
                    this.state.recurrences = parsedData.recurrences || []; 
                    this.state.categories = parsedData.categories || []; 
                } else { 
                    // Se não houver dados salvos, inicializa arrays vazios
                    Object.keys(this.state).forEach(key => { 
                        if (Array.isArray(this.state[key]) && key !== 'categories') { // Não sobrescreve as categorias padrão
                            this.state[key] = []; 
                        } 
                    }); 
                } 
            } catch (error) { 
                console.error("Failed to load data:", error); 
                // Em caso de erro, garante que os arrays estejam vazios para evitar falhas
                Object.keys(this.state).forEach(key => { 
                    if (Array.isArray(this.state[key]) && key !== 'categories') { 
                        this.state[key] = []; 
                    } 
                }); 
            } 
        },
        generateRecurringTransactions() { 
            const today = new Date(); 
            today.setHours(0, 0, 0, 0); 
            let somethingChanged = false; 
            
            this.state.recurrences.forEach(r => { 
                if (!r.nextDueDate) { // Se nextDueDate não existe, usa startDate para a primeira geração
                    r.nextDueDate = r.startDate;
                }
                let nextDueDate = new Date(r.nextDueDate + 'T00:00:00'); 

                while (nextDueDate <= today) { 
                    // Verifica se já existe uma transação gerada para esta recorrência nesta data
                    const alreadyGenerated = this.state.transactions.some(t => 
                        t.recurrenceId === r.id && 
                        t.date === r.nextDueDate && 
                        t.description === r.description && 
                        t.amount === r.amount
                    );

                    if (!alreadyGenerated) {
                        const newTransaction = { 
                            id: Date.now().toString() + Math.random(), 
                            type: r.type, 
                            description: r.description, 
                            amount: r.amount, 
                            date: r.nextDueDate, 
                            accountId: r.accountId, 
                            category: r.category, 
                            isPaid: r.type === 'income', // Receitas são marcadas como pagas automaticamente
                            dueDate: r.nextDueDate, // Despesas recorrentes tem a data de vencimento igual à data da transação
                            recurrenceId: r.id // Link para a recorrência original
                        }; 
                        this.state.transactions.push(newTransaction); 
                        somethingChanged = true; 
                    }
                   
                    // Avança para a próxima data de vencimento
                    if (r.frequency === 'monthly') { 
                        nextDueDate.setMonth(nextDueDate.getMonth() + 1); 
                    } else if (r.frequency === 'weekly') { 
                        nextDueDate.setDate(nextDueDate.getDate() + 7); 
                    } else if (r.frequency === 'yearly') { 
                        nextDueDate.setFullYear(nextDueDate.getFullYear() + 1); 
                    } 
                    r.nextDueDate = nextDueDate.toISOString().split('T')[0]; 
                } 
            }); 
            if (somethingChanged) { 
                this.saveData(); 
            } 
        },
        checkLogin() { 
            const user = localStorage.getItem('financeAppUser'); 
            if (user) { 
                this.state.user = user; 
                this.elements.loginContainer.style.display = 'none'; 
                this.elements.appContainer.style.display = 'block'; 
                this.initApp(); 
            } else { 
                this.elements.loginContainer.style.display = 'flex'; 
                this.elements.appContainer.style.display = 'none'; 
            } 
        },
        handleLogin() { 
            const username = this.elements.usernameInput.value.trim(); 
            if (username) { 
                localStorage.setItem('financeAppUser', username); 
                this.checkLogin(); 
            } else { 
                alert('Por favor, digite seu nome.'); 
            } 
        },
        handleLogout() { 
            if (confirm('Você tem certeza que deseja sair?')) { 
                localStorage.removeItem('financeAppUser'); 
                window.location.reload(); 
            } 
        },
        toggleTheme() { 
            document.body.classList.toggle('light-mode'); 
            const isLight = document.body.classList.contains('light-mode'); 
            this.elements.themeToggle.textContent = isLight ? '🌙' : '☀️'; 
            localStorage.setItem('financeTheme', isLight ? 'light' : 'dark'); 
            this.updateCharts(); // Atualiza os gráficos para refletir o tema
        },
        applySavedTheme() { 
            const savedTheme = localStorage.getItem('financeTheme'); 
            if (savedTheme === 'light') { 
                document.body.classList.add('light-mode'); 
                this.elements.themeToggle.textContent = '🌙'; 
            } else { 
                document.body.classList.remove('light-mode'); 
                this.elements.themeToggle.textContent = '☀️'; 
            } 
        },
        handleTabClick(e) { 
            if (this.state.editingItem) { this.cancelEditMode(); } 
            this.elements.tabs.forEach(tab => tab.classList.remove('active')); 
            this.elements.tabContents.forEach(content => content.classList.remove('active')); 
            const tabButton = e.currentTarget; 
            tabButton.classList.add('active'); 
            document.getElementById(`tab-${tabButton.dataset.tab}`).classList.add('active'); 
            this.updateAllRenders(); // Garante que a tab ativa sempre renderize corretamente
        },
        toggleTransactionFormLock() { 
            const hasAccounts = this.state.accounts.length > 0; 
            this.elements.transactionFormBlocker.classList.toggle('hidden', hasAccounts); 
            const formElements = this.elements.transactionForm.elements; 
            for (let i = 0; i < formElements.length; i++) { 
                formElements[i].disabled = !hasAccounts; 
            } 
        },
        handleTransactionTypeChange() { 
            const type = this.elements.transactionTypeSelect.value; 
            const isExpense = type === 'expense'; 
            this.elements.dueDateGroup.style.display = isExpense ? 'block' : 'none'; 
            this.elements.dueDateInput.required = isExpense; 
            this.elements.makeRecurringGroup.style.display = isExpense ? 'block' : 'none'; 
        },
        formatCurrency(value) { return (value || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }); },
        formatDate(dateString) { if (!dateString) return 'N/A'; const date = new Date(dateString + 'T00:00:00'); return date.toLocaleDateString('pt-BR'); },
        populateSelectors() {
            const categoryOptions = this.state.categories.map(c => ({ value: c.name, text: c.name }));
            const allAccounts = this.state.accounts.map(a => ({ value: a.id, text: `${a.name} (${a.type === 'credit_card' ? 'Crédito' : a.type === 'checking' ? 'Corrente' : a.type === 'savings' ? 'Poupança' : 'Dinheiro'})` }));
            const nonCreditAccounts = this.state.accounts.filter(a => a.type !== 'credit_card').map(a => ({ value: a.id, text: `${a.name} (${a.type === 'checking' ? 'Corrente' : a.type === 'savings' ? 'Poupança' : 'Dinheiro'})` }));
            
            const selectors = {
                'account-select': allAccounts, 
                'transfer-from-account': allAccounts, 
                'transfer-to-account': nonCreditAccounts,
                'category-select': categoryOptions, 
                'budget-category': categoryOptions,
                'category-filter': [{value: 'all', text: 'Todas as Categorias'}, ...categoryOptions],
                'recurrence-account': allAccounts, 
                'recurrence-category': categoryOptions,
            };
            for (const id in selectors) {
                const select = document.getElementById(id);
                if(select) {
                    const currentValue = select.value; 
                    select.innerHTML = '';
                    selectors[id].forEach(opt => { 
                        const option = document.createElement('option'); 
                        option.value = opt.value; 
                        option.textContent = opt.text; 
                        select.appendChild(option); 
                    });
                    // Tenta restaurar o valor selecionado
                    if (Array.from(select.options).some(opt => opt.value === currentValue)) { 
                        select.value = currentValue; 
                    } else if (selectors[id].length > 0) {
                        select.value = selectors[id][0].value; // Seleciona o primeiro se o valor atual não existe
                    }
                }
            }
        },
        renderSummary() { 
            const now = new Date(); 
            const currentMonth = now.getMonth(); 
            const currentYear = now.getFullYear(); 
            
            const monthlyIncome = this.state.transactions.filter(t => 
                new Date(t.date).getMonth() === currentMonth && 
                new Date(t.date).getFullYear() === currentYear && 
                t.type === 'income' && 
                t.category !== 'Transferência'
            ).reduce((sum, t) => sum + (t.amount || 0), 0); 
            
            const monthlyExpense = this.state.transactions.filter(t => 
                new Date(t.date).getMonth() === currentMonth && 
                new Date(t.date).getFullYear() === currentYear && 
                t.type === 'expense' && 
                t.isPaid && 
                t.category !== 'Transferência'
            ).reduce((sum, t) => sum + (t.amount || 0), 0); 
            
            const balance = this.state.accounts.reduce((sum, acc) => { 
                const currentVal = acc.currentBalance || 0; 
                return acc.type === 'credit_card' ? sum - currentVal : sum + currentVal; 
            }, 0); 
            
            const balanceEl = document.getElementById('balance'); 
            balanceEl.textContent = this.formatCurrency(balance); 
            balanceEl.className = `amount ${balance >= 0 ? 'positive' : 'negative'}`; 
            document.getElementById('total-income').textContent = this.formatCurrency(monthlyIncome); 
            document.getElementById('total-expense').textContent = this.formatCurrency(monthlyExpense); 
        },
        getFilteredTransactions() {
            const dateFilter = document.getElementById('date-filter').value;
            const categoryFilter = document.getElementById('category-filter').value;
            const paymentStatusFilter = document.getElementById('payment-status-filter').value;
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());

            return this.state.transactions.filter(t => {
                const transactionDate = new Date(t.date + 'T00:00:00');
                const transactionDueDate = t.dueDate ? new Date(t.dueDate + 'T00:00:00') : null;
                
                // Filter by date
                if (dateFilter === '7') {
                    const sevenDaysAgo = new Date(now);
                    sevenDaysAgo.setDate(now.getDate() - 7);
                    if (transactionDate < sevenDaysAgo) return false;
                } else if (dateFilter === '30') {
                    const thirtyDaysAgo = new Date(now);
                    thirtyDaysAgo.setDate(now.getDate() - 30);
                    if (transactionDate < thirtyDaysAgo) return false;
                } else if (dateFilter === 'month') {
                    if (transactionDate.getMonth() !== now.getMonth() || transactionDate.getFullYear() !== now.getFullYear()) return false;
                }

                // Filter by category
                if (categoryFilter !== 'all' && t.category !== categoryFilter) {
                    return false;
                }

                // Filter by payment status
                if (paymentStatusFilter === 'paid' && !t.isPaid) {
                    return false;
                }
                if (paymentStatusFilter === 'unpaid' && t.isPaid) {
                    return false;
                }

                return true;
            }).sort((a, b) => new Date(b.date) - new Date(a.date));
        },
        renderTransactions() { 
            const transactionList = document.getElementById('transaction-list');
            transactionList.innerHTML = '';
            const filteredTransactions = this.getFilteredTransactions();
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());

            if (filteredTransactions.length === 0) {
                transactionList.innerHTML = `<p style="text-align: center; color: var(--text-muted-color);">Nenhuma transação encontrada para os filtros selecionados.</p>`;
                return;
            }

            filteredTransactions.forEach(t => {
                const account = this.state.accounts.find(acc => acc.id === t.accountId);
                const category = this.state.categories.find(cat => cat.name === t.category); // Busca a categoria pelo nome
                const isCreditCard = account && account.type === 'credit_card';

                let itemClass = t.type;
                let statusTag = '';
                let dueDateTag = '';

                if (t.type === 'expense') {
                    if (t.isPaid) {
                        itemClass += ' paid';
                        statusTag = `<span class="details-tag paid-tag">Paga</span>`;
                    } else {
                        const dueDate = t.dueDate ? new Date(t.dueDate + 'T00:00:00') : null;
                        if (dueDate) {
                            const diffDays = Math.ceil((dueDate.getTime() - today.getTime()) / (1000 * 60 * 60 * 24));
                            if (diffDays >= 0 && diffDays <= 7) {
                                itemClass += ' due-soon';
                                dueDateTag = `<span class="details-tag due-date-tag">Vence em ${diffDays} dias</span>`;
                            } else if (diffDays < 0) {
                                itemClass += ' overdue';
                                dueDateTag = `<span class="details-tag due-date-tag">Vencida (${Math.abs(diffDays)} dias)</span>`;
                            }
                        }
                        statusTag = `<span class="details-tag">A Pagar</span>`;
                    }
                } else if (t.type === 'income') {
                    if (t.isPaid) {
                        itemClass += ' paid';
                        statusTag = `<span class="details-tag paid-tag">Recebida</span>`;
                    } else {
                         statusTag = `<span class="details-tag">A Receber</span>`;
                    }
                }
                
                const deleteButtonHtml = `<button class="delete-button" data-id="${t.id}">${this.getDeleteIconSVG()}</button>`;
                const editButtonHtml = `<button class="edit-btn" data-id="${t.id}" data-type="transaction">${this.getEditIconSVG()}</button>`;
                const payButtonHtml = (!t.isPaid && t.type === 'expense') ? `<button class="btn btn-success btn-sm pay-btn" data-id="${t.id}" style="font-size: 0.8rem; padding: 5px 10px;">Pagar</button>` : '';


                const li = document.createElement('li');
                li.className = `transaction-item ${itemClass}`;
                li.innerHTML = `
                    <div class="info">
                        <div class="description">${t.description}</div>
                        <div class="details">
                            <span class="details-tag">${account ? account.name : 'N/A'}</span>
                            <span class="details-tag">${category ? category.name : 'N/A'}</span>
                            <span class="details-tag">${this.formatDate(t.date)}</span>
                            ${t.type === 'expense' ? `<span class="details-tag">${this.formatDate(t.dueDate)}</span>` : ''}
                            ${statusTag}
                            ${dueDateTag}
                        </div>
                    </div>
                    <div class="amount ${t.type}">${this.formatCurrency(t.amount)}</div>
                    <div class="actions">
                        ${payButtonHtml}
                        ${editButtonHtml}
                        ${deleteButtonHtml}
                    </div>
                `;
                transactionList.appendChild(li);
            });
        },
        renderAccounts() { 
            const accountsList = document.getElementById('accounts-list');
            accountsList.innerHTML = '';
            if (this.state.accounts.length === 0) {
                accountsList.innerHTML = `<p style="text-align: center; color: var(--text-muted-color);">Nenhuma conta cadastrada.</p>`;
                return;
            }
            this.state.accounts.forEach(acc => {
                const accountBalance = acc.type === 'credit_card' ? this.formatCurrency(acc.currentBalance * -1) : this.formatCurrency(acc.currentBalance);
                const li = document.createElement('div');
                li.className = 'list-item';
                li.innerHTML = `
                    <div class="list-item-header">
                        <div class="main-info">
                            <h3>${acc.name}</h3>
                            <p style="color: var(--text-muted-color); font-size: 0.9rem;">${acc.type === 'checking' ? 'Conta Corrente' : acc.type === 'savings' ? 'Poupança' : acc.type === 'cash' ? 'Dinheiro' : 'Cartão de Crédito'}</p>
                        </div>
                        <div class="actions">
                            <button class="edit-btn" data-id="${acc.id}" data-type="account">${this.getEditIconSVG()}</button>
                            <button class="delete-button" data-id="${acc.id}">${this.getDeleteIconSVG()}</button>
                        </div>
                    </div>
                    <p style="font-weight: 600; margin-top: 10px;">Saldo Atual: <span class="${acc.currentBalance >= 0 ? 'positive' : 'negative'}">${accountBalance}</span></p>
                `;
                accountsList.appendChild(li);
            });
        },
        renderBudgets() { 
            const budgetsList = document.getElementById('budgets-list');
            budgetsList.innerHTML = '';
            if (this.state.budgets.length === 0) {
                budgetsList.innerHTML = `<p style="text-align: center; color: var(--text-muted-color);">Nenhum orçamento definido.</p>`;
                return;
            }
            const now = new Date();
            const currentMonthExpenses = this.state.transactions.filter(t => 
                t.type === 'expense' && t.isPaid && 
                new Date(t.date).getMonth() === now.getMonth() && 
                new Date(t.date).getFullYear() === now.getFullYear()
            );

            this.state.budgets.forEach(budget => {
                const spent = currentMonthExpenses
                    .filter(t => t.category === budget.category)
                    .reduce((sum, t) => sum + (t.amount || 0), 0);
                
                const percentage = (spent / budget.amount) * 100;
                const progressClass = percentage > 100 ? 'over' : '';

                const li = document.createElement('div');
                li.className = 'list-item';
                li.innerHTML = `
                    <div class="list-item-header">
                        <div class="main-info">
                            <h3>${budget.category}</h3>
                            <p style="color: var(--text-muted-color); font-size: 0.9rem;">Limite: ${this.formatCurrency(budget.amount)}</p>
                        </div>
                        <div class="actions">
                            <button class="edit-btn" data-id="${budget.id}" data-type="budget">${this.getEditIconSVG()}</button>
                            <button class="delete-button" data-id="${budget.id}">${this.getDeleteIconSVG()}</button>
                        </div>
                    </div>
                    <p style="margin-top: 10px;">Gasto: ${this.formatCurrency(spent)}</p>
                    <div class="progress-bar-container">
                        <div class="progress-bar ${progressClass}" style="width: ${Math.min(100, percentage)}%;">
                            ${Math.round(percentage)}%
                        </div>
                    </div>
                    <p style="font-size: 0.85rem; color: var(--text-muted-color); margin-top: 5px;">
                        ${percentage > 100 ? `<span style="color: var(--error-color); font-weight: bold;">Estourou em ${this.formatCurrency(spent - budget.amount)}</span>` : `${this.formatCurrency(budget.amount - spent)} restante`}
                    </p>
                `;
                budgetsList.appendChild(li);
            });
        },
        renderGoals() { 
            const goalsList = document.getElementById('goals-list');
            goalsList.innerHTML = '';
            if (this.state.goals.length === 0) {
                goalsList.innerHTML = `<p style="text-align: center; color: var(--text-muted-color);">Nenhuma meta definida.</p>`;
                return;
            }
            this.state.goals.forEach(goal => {
                const progress = (goal.saved / goal.target) * 100;
                const remaining = goal.target - goal.saved;
                const li = document.createElement('div');
                li.className = 'list-item';
                li.innerHTML = `
                    <div class="list-item-header">
                        <div class="main-info">
                            <h3>${goal.name}</h3>
                            <p style="color: var(--text-muted-color); font-size: 0.9rem;">Alvo: ${this.formatCurrency(goal.target)}</p>
                        </div>
                        <div class="actions">
                            <button class="edit-btn" data-id="${goal.id}" data-type="goal">${this.getEditIconSVG()}</button>
                            <button class="delete-button" data-id="${goal.id}">${this.getDeleteIconSVG()}</button>
                        </div>
                    </div>
                    <p style="margin-top: 10px;">Guardado: ${this.formatCurrency(goal.saved)}</p>
                    <div class="progress-bar-container">
                        <div class="progress-bar" style="width: ${Math.min(100, progress)}%;">
                            ${Math.round(progress)}%
                        </div>
                    </div>
                    <p style="font-size: 0.85rem; color: var(--text-muted-color); margin-top: 5px;">
                        Faltam: ${this.formatCurrency(Math.max(0, remaining))}
                        ${goal.deadline ? ` (Prazo: ${this.formatDate(goal.deadline)})` : ''}
                    </p>
                    <form class="goal-contribution-form">
                        <input type="hidden" name="goalId" value="${goal.id}">
                        <input type="number" name="contributionAmount" step="0.01" placeholder="Valor p/ contribuir" required>
                        <select name="contributionAccount" required></select>
                        <button type="submit" class="btn btn-success">Contribuir</button>
                    </form>
                `;
                goalsList.appendChild(li);
                const contributionAccountSelect = li.querySelector('select[name="contributionAccount"]');
                const nonCreditAccounts = this.state.accounts.filter(a => a.type !== 'credit_card');
                nonCreditAccounts.forEach(acc => {
                    const option = document.createElement('option');
                    option.value = acc.id;
                    option.textContent = acc.name;
                    contributionAccountSelect.appendChild(option);
                });
            });
        },
        renderRecurrences() { 
            const recurrencesList = document.getElementById('recurrences-list');
            recurrencesList.innerHTML = '';
            if (this.state.recurrences.length === 0) {
                recurrencesList.innerHTML = `<p style="text-align: center; color: var(--text-muted-color);">Nenhum lançamento recorrente.</p>`;
                return;
            }
            this.state.recurrences.forEach(rec => {
                const account = this.state.accounts.find(acc => acc.id === rec.accountId);
                const li = document.createElement('div');
                li.className = 'list-item';
                li.innerHTML = `
                    <div class="list-item-header">
                        <div class="main-info">
                            <h3>${rec.description} (${rec.type === 'income' ? 'Receita' : 'Despesa'})</h3>
                            <p style="color: var(--text-muted-color); font-size: 0.9rem;">
                                ${this.formatCurrency(rec.amount)} 
                                / ${rec.frequency === 'monthly' ? 'Mensal' : rec.frequency === 'weekly' ? 'Semanal' : 'Anual'}
                                <br>
                                Conta: ${account ? account.name : 'N/A'} - Categoria: ${rec.category}
                                <br>
                                Próx. Venc.: ${this.formatDate(rec.nextDueDate)}
                            </p>
                        </div>
                        <div class="actions">
                            <button class="edit-btn" data-id="${rec.id}" data-type="recurrence">${this.getEditIconSVG()}</button>
                            <button class="delete-button" data-id="${rec.id}">${this.getDeleteIconSVG()}</button>
                        </div>
                    </div>
                `;
                recurrencesList.appendChild(li);
            });
        },
        renderCategories() { 
            const categoriesList = document.getElementById('categories-list');
            categoriesList.innerHTML = '';
            if (this.state.categories.length === 0) {
                categoriesList.innerHTML = `<p style="text-align: center; color: var(--text-muted-color);">Nenhuma categoria cadastrada.</p>`;
                return;
            }
            this.state.categories.forEach(cat => {
                const li = document.createElement('div');
                li.className = 'list-item category-item';
                li.innerHTML = `
                    <div class="main-info">
                        <h3>${cat.name}</h3>
                    </div>
                    <div class="actions">
                        <button class="edit-btn" data-id="${cat.id}" data-type="category">${this.getEditIconSVG()}</button>
                        <button class="delete-button" data-id="${cat.id}">${this.getDeleteIconSVG()}</button>
                    </div>
                `;
                categoriesList.appendChild(li);
            });
        },
        updateAllRenders() { 
            try { 
                this.toggleTransactionFormLock(); 
                this.updateAccountBalances(); 
                this.populateSelectors(); 
                this.renderSummary(); 
                this.renderTransactions(); 
                this.renderAccounts(); 
                this.renderBudgets(); 
                this.renderGoals(); 
                this.renderRecurrences(); 
                this.renderCategories(); 
                this.updateCharts(); 
            } catch (error) { 
                console.error("An error occurred during a render update:", error); 
            } 
        },
        updateAccountBalances() { 
            this.state.accounts.forEach(acc => { 
                let balance = acc.initialBalance || 0; 
                this.state.transactions.forEach(t => { 
                    if (t.accountId === acc.id && t.category !== 'Transferência') { // Exclui transferências diretas do cálculo do balanço da conta, pois elas são compensadas
                        const amount = t.amount || 0; 
                        if (acc.type === 'credit_card') { 
                            if (t.type === 'expense' && t.isPaid) balance += amount; // Gasto no cartão de crédito aumenta o valor devido
                            if (t.type === 'income' && t.isPaid) balance -= amount; // Pagamento do cartão de crédito diminui o valor devido
                        } else { 
                            if (t.type === 'income' && t.isPaid) balance += amount; 
                            if (t.type === 'expense' && t.isPaid) balance -= amount; 
                        } 
                    }
                    // Lógica para transferências: afeta diretamente os saldos da conta de origem e destino
                    if (t.category === 'Transferência') {
                        if (t.accountId === acc.id) {
                            if (t.type === 'expense') { // Parte da transferência que sai da conta
                                balance -= (t.amount || 0);
                            } else if (t.type === 'income') { // Parte da transferência que entra na conta
                                balance += (t.amount || 0);
                            }
                        }
                    }
                }); 
                acc.currentBalance = balance; 
            }); 
            this.saveData(); // Salva os saldos atualizados
        },
        handleTransaction(e) {
            e.preventDefault();
            const form = e.target;
            const type = form.elements['transaction-type'].value;
            const description = form.elements['description'].value;
            const amount = parseFloat(form.elements['amount'].value);
            const date = form.elements['date'].value;
            const accountId = form.elements['account-select'].value;
            const category = form.elements['category-select'].value;
            const dueDate = form.elements['due-date'].value;
            const makeRecurring = form.elements['make-recurring-checkbox'].checked;

            if (!description || !amount || !date || !accountId || !category) {
                alert("Por favor, preencha todos os campos obrigatórios.");
                return;
            }

            let isPaid = type === 'income'; // Receitas são pagas por padrão

            // Se for despesa e não tiver data de vencimento, ou se for marcada como paga na hora
            if (type === 'expense' && (!dueDate || form.querySelector('#add-transaction-btn').textContent === 'Salvar Transação' && this.state.editingItem && this.state.editingItem.isPaid)) {
                isPaid = true;
            }

            if (this.state.editingItem) {
                const index = this.state.transactions.findIndex(t => t.id === this.state.editingItem.id);
                if (index !== -1) {
                    this.state.transactions[index] = {
                        ...this.state.transactions[index],
                        type, description, amount, date, accountId, category, isPaid, dueDate
                    };
                }
                alert("Transação atualizada com sucesso!");
            } else {
                const newTransaction = {
                    id: Date.now().toString() + Math.random(), // ID único
                    type, description, amount, date, accountId, category, isPaid, dueDate
                };
                this.state.transactions.push(newTransaction);
                alert("Transação adicionada com sucesso!");
                
                // Se for despesa e marcada como recorrente
                if (type === 'expense' && makeRecurring) {
                    const recurrenceId = `rec-${Date.now()}`;
                    const recurrence = {
                        id: recurrenceId,
                        description: newTransaction.description,
                        amount: newTransaction.amount,
                        type: newTransaction.type,
                        accountId: newTransaction.accountId,
                        category: newTransaction.category,
                        frequency: 'monthly', // Por enquanto, só mensal
                        startDate: newTransaction.date,
                        nextDueDate: new Date(new Date(newTransaction.date + 'T00:00:00').setMonth(new Date(newTransaction.date + 'T00:00:00').getMonth() + 1)).toISOString().split('T')[0] // Próximo mês
                    };
                    this.state.recurrences.push(recurrence);
                }
            }
            this.saveData();
            this.updateAllRenders();
            form.reset();
            document.getElementById('date').valueAsDate = new Date();
            this.cancelEditMode(); // Sai do modo de edição
        },
        handleAccount(e) {
            e.preventDefault();
            const form = e.target;
            const name = form.elements['account-name'].value;
            const type = form.elements['account-type'].value;
            const initialBalance = parseFloat(form.elements['initial-balance'].value);

            if (!name) { alert("Por favor, preencha o nome da conta."); return; }

            if (this.state.editingItem) {
                const index = this.state.accounts.findIndex(acc => acc.id === this.state.editingItem.id);
                if (index !== -1) {
                    this.state.accounts[index] = { ...this.state.accounts[index], name, type, initialBalance, currentBalance: initialBalance };
                }
                alert("Conta atualizada com sucesso!");
            } else {
                const newAccount = {
                    id: Date.now().toString(),
                    name, type, initialBalance, currentBalance: initialBalance
                };
                this.state.accounts.push(newAccount);
                alert("Conta adicionada com sucesso!");
            }
            this.saveData();
            this.updateAllRenders();
            form.reset();
            this.cancelEditMode();
        },
        handleBudget(e) {
            e.preventDefault();
            const form = e.target;
            const category = form.elements['budget-category'].value;
            const amount = parseFloat(form.elements['budget-amount'].value);

            if (!category || !amount) { alert("Por favor, preencha todos os campos."); return; }

            if (this.state.editingItem) {
                const index = this.state.budgets.findIndex(b => b.id === this.state.editingItem.id);
                if (index !== -1) {
                    this.state.budgets[index] = { ...this.state.budgets[index], category, amount };
                }
                alert("Orçamento atualizado com sucesso!");
            } else {
                const newBudget = {
                    id: Date.now().toString(), category, amount
                };
                this.state.budgets.push(newBudget);
                alert("Orçamento adicionado com sucesso!");
            }
            this.saveData();
            this.updateAllRenders();
            form.reset();
            this.cancelEditMode();
        },
        handleGoal(e) {
            e.preventDefault();
            const form = e.target;
            const name = form.elements['goal-name'].value;
            const target = parseFloat(form.elements['goal-target'].value);
            const saved = parseFloat(form.elements['goal-saved'].value);
            const deadline = form.elements['goal-deadline'].value;

            if (!name || !target) { alert("Por favor, preencha todos os campos obrigatórios."); return; }

            if (this.state.editingItem) {
                const index = this.state.goals.findIndex(g => g.id === this.state.editingItem.id);
                if (index !== -1) {
                    this.state.goals[index] = { ...this.state.goals[index], name, target, saved, deadline };
                }
                alert("Meta atualizada com sucesso!");
            } else {
                const newGoal = {
                    id: Date.now().toString(), name, target, saved, deadline
                };
                this.state.goals.push(newGoal);
                alert("Meta criada com sucesso!");
            }
            this.saveData();
            this.updateAllRenders();
            form.reset();
            this.cancelEditMode();
        },
        handleRecurrence(e) {
            e.preventDefault();
            const form = e.target;
            const description = form.elements['recurrence-description'].value;
            const amount = parseFloat(form.elements['recurrence-amount'].value);
            const type = form.elements['recurrence-type'].value;
            const accountId = form.elements['recurrence-account'].value;
            const category = form.elements['recurrence-category'].value;
            const frequency = form.elements['recurrence-frequency'].value;
            const startDate = form.elements['recurrence-start-date'].value;

            if (!description || !amount || !type || !accountId || !category || !frequency || !startDate) {
                alert("Por favor, preencha todos os campos obrigatórios.");
                return;
            }

            if (this.state.editingItem) {
                const index = this.state.recurrences.findIndex(r => r.id === this.state.editingItem.id);
                if (index !== -1) {
                    this.state.recurrences[index] = { ...this.state.recurrences[index], description, amount, type, accountId, category, frequency, startDate };
                }
                alert("Lançamento recorrente atualizado com sucesso!");
            } else {
                const newRecurrence = {
                    id: Date.now().toString(), description, amount, type, accountId, category, frequency, startDate, nextDueDate: startDate
                };
                this.state.recurrences.push(newRecurrence);
                alert("Lançamento recorrente adicionado com sucesso!");
            }
            this.saveData();
            this.generateRecurringTransactions(); // Gera transações para a nova recorrência imediatamente
            this.updateAllRenders();
            form.reset();
            this.cancelEditMode();
        },
        handleCategorySubmit(e) {
            e.preventDefault();
            const form = e.target;
            const categoryName = form.elements['category-name'].value.trim();

            if (!categoryName) {
                alert("Por favor, digite o nome da categoria.");
                return;
            }

            // Verifica se a categoria já existe
            const exists = this.state.categories.some(cat => cat.name.toLowerCase() === categoryName.toLowerCase());
            if (exists) {
                alert("Esta categoria já existe!");
                return;
            }

            if (this.state.editingItem) {
                const index = this.state.categories.findIndex(cat => cat.id === this.state.editingItem.id);
                if (index !== -1) {
                    this.state.categories[index].name = categoryName;
                }
                alert("Categoria atualizada com sucesso!");
            } else {
                const newCategory = {
                    id: Date.now().toString(),
                    name: categoryName
                };
                this.state.categories.push(newCategory);
                alert("Categoria adicionada com sucesso!");
            }
            this.saveData();
            this.updateAllRenders();
            form.reset();
            this.cancelEditMode();
        },
        
        handleTransfer(e) {
            e.preventDefault();
            const form = e.target;
            const fromAccountId = form.elements['transfer-from-account'].value;
            const toAccountId = form.elements['transfer-to-account'].value;
            const amount = parseFloat(form.elements['transfer-amount'].value);
            const date = form.elements['transfer-date'].value;
            const description = form.elements['transfer-description'].value || 'Transferência entre contas';

            if (fromAccountId === toAccountId) { alert("A conta de origem e destino não podem ser a mesma."); return; }
            if (!fromAccountId || !toAccountId || !amount || !date) { alert("Preencha todos os campos obrigatórios para a transferência."); return; }
            
            const transferId = `transfer-${Date.now()}`;
            // Parte da despesa (saída)
            const expense_part = { 
                id: Date.now().toString() + '-out', 
                type: 'expense', 
                description: `Transferência enviada para ${this.state.accounts.find(a => a.id === toAccountId)?.name || 'Outra Conta'} - ${description}`, 
                amount, 
                date, 
                accountId: fromAccountId, 
                category: 'Transferência', 
                isPaid: true, 
                dueDate: date, 
                transferId 
            };
            // Parte da receita (entrada)
            const income_part = { 
                id: Date.now().toString() + '-in', 
                type: 'income', 
                description: `Transferência recebida de ${this.state.accounts.find(a => a.id === fromAccountId)?.name || 'Outra Conta'} - ${description}`, 
                amount, 
                date, 
                accountId: toAccountId, 
                category: 'Transferência', 
                isPaid: true, 
                dueDate: date, 
                transferId 
            };
            
            this.state.transactions.push(expense_part, income_part);
            this.saveData();
            this.updateAllRenders();
            form.reset();
            document.getElementById('transfer-date').valueAsDate = new Date();
            alert("Transferência realizada com sucesso!");
        },

        markAsPaid(id) { 
            const transaction = this.state.transactions.find(t => t.id === id);
            if (transaction) {
                transaction.isPaid = true;
                this.saveData();
                this.updateAllRenders();
            }
        },
        deleteTransaction(id) {
            const transaction_to_delete = this.state.transactions.find(t => t.id === id);
            if (!transaction_to_delete) return;
            let confirm_message = 'Tem certeza que quer deletar esta transação?';
            let also_delete_id = null;
            if(transaction_to_delete.transferId) {
                confirm_message = 'Esta é uma transação de transferência. Deletá-la também removerá a outra parte da transferência. Deseja continuar?';
                const other_part = this.state.transactions.find(t => t.transferId === transaction_to_delete.transferId && t.id !== id);
                if(other_part) also_delete_id = other_part.id;
            }
            if (confirm(confirm_message)) {
                this.state.transactions = this.state.transactions.filter(t => t.id !== id && t.id !== also_delete_id);
                this.saveData(); 
                this.updateAllRenders();
            }
        },
        deleteAccount(id) { 
            if (confirm('Tem certeza que quer deletar esta conta? Todas as transações associadas serão perdidas.')) {
                this.state.accounts = this.state.accounts.filter(acc => acc.id !== id);
                // Remove transações associadas a esta conta
                this.state.transactions = this.state.transactions.filter(t => t.accountId !== id);
                this.saveData();
                this.updateAllRenders();
            }
        },
        deleteBudget(id) { 
            if (confirm('Tem certeza que quer deletar este orçamento?')) {
                this.state.budgets = this.state.budgets.filter(b => b.id !== id);
                this.saveData();
                this.updateAllRenders();
            }
        },
        deleteGoal(id) { 
            if (confirm('Tem certeza que quer deletar esta meta?')) {
                this.state.goals = this.state.goals.filter(g => g.id !== id);
                this.saveData();
                this.updateAllRenders();
            }
        },
        deleteRecurrence(id) { 
            if (confirm('Tem certeza que quer deletar este lançamento recorrente? Transações já geradas não serão removidas.')) {
                this.state.recurrences = this.state.recurrences.filter(r => r.id !== id);
                this.saveData();
                this.updateAllRenders();
            }
        },
        deleteCategory(id) { 
            // Permite deletar apenas categorias que não estão em uso por transações ou orçamentos
            const categoryToDelete = this.state.categories.find(c => c.id === id);
            if (!categoryToDelete) return;

            const isCategoryInUse = this.state.transactions.some(t => t.category === categoryToDelete.name) ||
                                   this.state.budgets.some(b => b.category === categoryToDelete.name);

            if (isCategoryInUse) {
                alert("Não é possível deletar esta categoria. Ela está sendo usada em transações ou orçamentos.");
                return;
            }

            if (confirm(`Tem certeza que quer deletar a categoria "${categoryToDelete.name}"?`)) {
                this.state.categories = this.state.categories.filter(c => c.id !== id);
                this.saveData();
                this.updateAllRenders();
            }
        },
        handleGoalContribution(e) { 
            e.preventDefault();
            const form = e.target;
            const goalId = form.elements['goalId'].value;
            const contributionAmount = parseFloat(form.elements['contributionAmount'].value);
            const contributionAccountId = form.elements['contributionAccount'].value;

            if (!contributionAmount || !contributionAccountId) {
                alert("Por favor, preencha o valor e selecione a conta para a contribuição.");
                return;
            }

            const goal = this.state.goals.find(g => g.id === goalId);
            const account = this.state.accounts.find(a => a.id === contributionAccountId);

            if (goal && account) {
                if (account.currentBalance < contributionAmount && account.type !== 'credit_card') {
                    alert("Saldo insuficiente na conta selecionada para esta contribuição.");
                    return;
                }

                goal.saved += contributionAmount;
                // Cria uma transação de saída para a contribuição
                const newTransaction = {
                    id: Date.now().toString() + '-goal',
                    type: 'expense',
                    description: `Contribuição para meta: ${goal.name}`,
                    amount: contributionAmount,
                    date: new Date().toISOString().split('T')[0],
                    accountId: contributionAccountId,
                    category: 'Metas', // Categoria específica para metas
                    isPaid: true,
                    dueDate: new Date().toISOString().split('T')[0]
                };
                this.state.transactions.push(newTransaction);

                this.saveData();
                this.updateAllRenders();
                form.reset();
                alert(`Contribuído ${this.formatCurrency(contributionAmount)} para a meta "${goal.name}".`);
            } else {
                alert("Meta ou conta não encontrada.");
            }
        },
        startEditMode(type, id) { 
            this.state.editingItem = { id, type };
            let item;
            let form;
            let formTitle;
            let submitButton;

            switch (type) {
                case 'transaction':
                    item = this.state.transactions.find(t => t.id === id);
                    form = document.getElementById('transaction-form');
                    formTitle = document.getElementById('transaction-form-title');
                    submitButton = document.getElementById('add-transaction-btn');
                    if (item) {
                        form.elements['transaction-type'].value = item.type;
                        form.elements['description'].value = item.description;
                        form.elements['amount'].value = item.amount;
                        form.elements['date'].value = item.date;
                        form.elements['account-select'].value = item.accountId;
                        form.elements['category-select'].value = item.category;
                        form.elements['due-date'].value = item.dueDate || '';
                        this.elements.makeRecurringGroup.style.display = 'none'; // Desabilita recorrência em edição
                        this.elements.makeRecurringCheckbox.checked = false;
                        this.handleTransactionTypeChange(); // Para atualizar a visibilidade do campo de vencimento
                        formTitle.textContent = "Editar Transação";
                        submitButton.textContent = "Salvar Alterações";
                        submitButton.classList.add('btn-secondary');
                        submitButton.classList.remove('btn-primary');
                        // Adicionar botão de cancelar
                        if (!document.getElementById('cancel-edit-btn')) {
                            const cancelButton = document.createElement('button');
                            cancelButton.id = 'cancel-edit-btn';
                            cancelButton.type = 'button';
                            cancelButton.className = 'btn btn-secondary';
                            cancelButton.textContent = 'Cancelar';
                            cancelButton.addEventListener('click', () => this.cancelEditMode());
                            document.getElementById('transaction-form-buttons').appendChild(cancelButton);
                        }
                    }
                    break;
                case 'account':
                    item = this.state.accounts.find(a => a.id === id);
                    form = document.getElementById('account-form');
                    formTitle = document.getElementById('account-form-title');
                    submitButton = form.querySelector('.btn-primary');
                    if (item) {
                        form.elements['account-name'].value = item.name;
                        form.elements['account-type'].value = item.type;
                        form.elements['initial-balance'].value = item.initialBalance;
                        this.elements.initialBalanceLabel.textContent = item.type === 'credit_card' ? 'Fatura Inicial (R$)' : 'Saldo Inicial (R$)';
                        formTitle.textContent = "Editar Conta/Cartão";
                        submitButton.textContent = "Salvar Alterações";
                        submitButton.classList.add('btn-secondary');
                        submitButton.classList.remove('btn-primary');
                        if (!document.getElementById('cancel-edit-btn-acc')) {
                            const cancelButton = document.createElement('button');
                            cancelButton.id = 'cancel-edit-btn-acc';
                            cancelButton.type = 'button';
                            cancelButton.className = 'btn btn-secondary';
                            cancelButton.textContent = 'Cancelar';
                            cancelButton.addEventListener('click', () => this.cancelEditMode());
                            document.getElementById('account-form-buttons').appendChild(cancelButton);
                        }
                    }
                    break;
                case 'budget':
                    item = this.state.budgets.find(b => b.id === id);
                    form = document.getElementById('budget-form');
                    formTitle = document.getElementById('budget-form-title');
                    submitButton = form.querySelector('.btn-primary');
                    if (item) {
                        form.elements['budget-category'].value = item.category;
                        form.elements['budget-amount'].value = item.amount;
                        formTitle.textContent = "Editar Orçamento";
                        submitButton.textContent = "Salvar Alterações";
                        submitButton.classList.add('btn-secondary');
                        submitButton.classList.remove('btn-primary');
                        if (!document.getElementById('cancel-edit-btn-bud')) {
                            const cancelButton = document.createElement('button');
                            cancelButton.id = 'cancel-edit-btn-bud';
                            cancelButton.type = 'button';
                            cancelButton.className = 'btn btn-secondary';
                            cancelButton.textContent = 'Cancelar';
                            cancelButton.addEventListener('click', () => this.cancelEditMode());
                            document.getElementById('budget-form-buttons').appendChild(cancelButton);
                        }
                    }
                    break;
                case 'goal':
                    item = this.state.goals.find(g => g.id === id);
                    form = document.getElementById('goal-form');
                    formTitle = document.getElementById('goal-form-title');
                    submitButton = form.querySelector('.btn-primary');
                    if (item) {
                        form.elements['goal-name'].value = item.name;
                        form.elements['goal-target'].value = item.target;
                        form.elements['goal-saved'].value = item.saved;
                        form.elements['goal-deadline'].value = item.deadline || '';
                        formTitle.textContent = "Editar Meta";
                        submitButton.textContent = "Salvar Alterações";
                        submitButton.classList.add('btn-secondary');
                        submitButton.classList.remove('btn-primary');
                        if (!document.getElementById('cancel-edit-btn-goal')) {
                            const cancelButton = document.createElement('button');
                            cancelButton.id = 'cancel-edit-btn-goal';
                            cancelButton.type = 'button';
                            cancelButton.className = 'btn btn-secondary';
                            cancelButton.textContent = 'Cancelar';
                            cancelButton.addEventListener('click', () => this.cancelEditMode());
                            document.getElementById('goal-form-buttons').appendChild(cancelButton);
                        }
                    }
                    break;
                case 'recurrence':
                    item = this.state.recurrences.find(r => r.id === id);
                    form = document.getElementById('recurrence-form');
                    formTitle = document.getElementById('recurrence-form-title');
                    submitButton = form.querySelector('.btn-primary');
                    if (item) {
                        form.elements['recurrence-description'].value = item.description;
                        form.elements['recurrence-amount'].value = item.amount;
                        form.elements['recurrence-type'].value = item.type;
                        form.elements['recurrence-account'].value = item.accountId;
                        form.elements['recurrence-category'].value = item.category;
                        form.elements['recurrence-frequency'].value = item.frequency;
                        form.elements['recurrence-start-date'].value = item.startDate;
                        formTitle.textContent = "Editar Lançamento Recorrente";
                        submitButton.textContent = "Salvar Alterações";
                        submitButton.classList.add('btn-secondary');
                        submitButton.classList.remove('btn-primary');
                        if (!document.getElementById('cancel-edit-btn-rec')) {
                            const cancelButton = document.createElement('button');
                            cancelButton.id = 'cancel-edit-btn-rec';
                            cancelButton.type = 'button';
                            cancelButton.className = 'btn btn-secondary';
                            cancelButton.textContent = 'Cancelar';
                            cancelButton.addEventListener('click', () => this.cancelEditMode());
                            document.getElementById('recurrence-form-buttons').appendChild(cancelButton);
                        }
                    }
                    break;
                case 'category':
                    item = this.state.categories.find(c => c.id === id);
                    form = document.getElementById('category-form');
                    formTitle = document.getElementById('category-form-title');
                    submitButton = form.querySelector('.btn-primary');
                    if (item) {
                        form.elements['category-name'].value = item.name;
                        formTitle.textContent = "Editar Categoria";
                        submitButton.textContent = "Salvar Alterações";
                        submitButton.classList.add('btn-secondary');
                        submitButton.classList.remove('btn-primary');
                        if (!document.getElementById('cancel-edit-btn-cat')) {
                            const cancelButton = document.createElement('button');
                            cancelButton.id = 'cancel-edit-btn-cat';
                            cancelButton.type = 'button';
                            cancelButton.className = 'btn btn-secondary';
                            cancelButton.textContent = 'Cancelar';
                            cancelButton.addEventListener('click', () => this.cancelEditMode());
                            document.getElementById('category-form-buttons').appendChild(cancelButton);
                        }
                    }
                    break;
            }
        },
        cancelEditMode() { 
            this.state.editingItem = null;
            // Reset Transaction Form
            const transactionForm = document.getElementById('transaction-form');
            transactionForm.reset();
            document.getElementById('date').valueAsDate = new Date();
            document.getElementById('transaction-form-title').textContent = "Nova Transação";
            const addTransactionBtn = document.getElementById('add-transaction-btn');
            addTransactionBtn.textContent = "Adicionar Transação";
            addTransactionBtn.classList.add('btn-primary');
            addTransactionBtn.classList.remove('btn-secondary');
            this.elements.makeRecurringGroup.style.display = 'block'; // Reabilita recorrência no modo normal
            this.handleTransactionTypeChange(); // Garante que o due-date esteja correto

            // Remove o botão de cancelar se existir
            const cancelBtnTrans = document.getElementById('cancel-edit-btn');
            if (cancelBtnTrans) cancelBtnTrans.remove();

            // Reset Account Form
            const accountForm = document.getElementById('account-form');
            accountForm.reset();
            document.getElementById('account-form-title').textContent = "Adicionar Conta/Cartão";
            const addAccountBtn = accountForm.querySelector('.btn-primary');
            addAccountBtn.textContent = "Salvar Conta";
            addAccountBtn.classList.add('btn-primary');
            addAccountBtn.classList.remove('btn-secondary');
            const cancelBtnAcc = document.getElementById('cancel-edit-btn-acc');
            if (cancelBtnAcc) cancelBtnAcc.remove();
            this.elements.initialBalanceLabel.textContent = 'Saldo Inicial (R$)';


            // Reset Budget Form
            const budgetForm = document.getElementById('budget-form');
            budgetForm.reset();
            document.getElementById('budget-form-title').textContent = "Definir Orçamento";
            const addBudgetBtn = budgetForm.querySelector('.btn-primary');
            addBudgetBtn.textContent = "Salvar Orçamento";
            addBudgetBtn.classList.add('btn-primary');
            addBudgetBtn.classList.remove('btn-secondary');
            const cancelBtnBud = document.getElementById('cancel-edit-btn-bud');
            if (cancelBtnBud) cancelBtnBud.remove();

            // Reset Goal Form
            const goalForm = document.getElementById('goal-form');
            goalForm.reset();
            document.getElementById('goal-form-title').textContent = "Criar Nova Meta";
            const addGoalBtn = goalForm.querySelector('.btn-primary');
            addGoalBtn.textContent = "Criar Meta";
            addGoalBtn.classList.add('btn-primary');
            addGoalBtn.classList.remove('btn-secondary');
            const cancelBtnGoal = document.getElementById('cancel-edit-btn-goal');
            if (cancelBtnGoal) cancelBtnGoal.remove();

            // Reset Recurrence Form
            const recurrenceForm = document.getElementById('recurrence-form');
            recurrenceForm.reset();
            document.getElementById('recurrence-form-title').textContent = "Adicionar Lançamento Recorrente";
            const addRecurrenceBtn = recurrenceForm.querySelector('.btn-primary');
            addRecurrenceBtn.textContent = "Salvar Recorrência";
            addRecurrenceBtn.classList.add('btn-primary');
            addRecurrenceBtn.classList.remove('btn-secondary');
            const cancelBtnRec = document.getElementById('cancel-edit-btn-rec');
            if (cancelBtnRec) cancelBtnRec.remove();

            // Reset Category Form
            const categoryForm = document.getElementById('category-form');
            categoryForm.reset();
            document.getElementById('category-form-title').textContent = "Adicionar Categoria";
            const addCategoryBtn = categoryForm.querySelector('.btn-primary');
            addCategoryBtn.textContent = "Adicionar Categoria";
            addCategoryBtn.classList.add('btn-primary');
            addCategoryBtn.classList.remove('btn-secondary');
            const cancelBtnCat = document.getElementById('cancel-edit-btn-cat');
            if (cancelBtnCat) cancelBtnCat.remove();

            this.updateAllRenders();
        },
        getChartOptions() { 
            const isLightMode = document.body.classList.contains('light-mode');
            const textColor = isLightMode ? '#1f2937' : '#ffffff';
            const gridColor = isLightMode ? '#eef2f9' : '#0f3460';

            return {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        labels: {
                            color: textColor // Cor do texto da legenda
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed.y !== null) {
                                    label += financeApp.formatCurrency(context.parsed.y);
                                }
                                return label;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        grid: {
                            color: gridColor // Cor das linhas de grade do eixo X
                        },
                        ticks: {
                            color: textColor // Cor do texto dos ticks do eixo X
                        },
                        type: 'time',
                        time: {
                            unit: 'day',
                            tooltipFormat: 'dd/MM/yyyy',
                            displayFormats: {
                                day: 'dd/MM'
                            }
                        }
                    },
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: gridColor // Cor das linhas de grade do eixo Y
                        },
                        ticks: {
                            color: textColor, // Cor do texto dos ticks do eixo Y
                            callback: function(value) {
                                return financeApp.formatCurrency(value);
                            }
                        }
                    }
                }
            };
        },
        initCharts() { 
            const mainOverviewCtx = document.getElementById('main-overview-chart').getContext('2d');
            this.charts.mainOverviewChart = new Chart(mainOverviewCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: []
                },
                options: this.getChartOptions()
            });

            const evolutionCtx = document.getElementById('evolution-chart').getContext('2d');
            this.charts.evolutionChart = new Chart(evolutionCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: []
                },
                options: this.getChartOptions()
            });
        },
        updateCharts() {
            if (!this.charts.mainOverviewChart || !this.charts.evolutionChart) {
                this.initCharts(); // Garante que os gráficos existam antes de atualizar
            }

            const commonOptions = this.getChartOptions();
            const now = new Date();
            const firstDayOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
            const lastDayOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0);
            
            // Dados para o gráfico de Visão Geral do Mês (Barra)
            const dataByDay = {};
            for (let d = new Date(firstDayOfMonth); d <= lastDayOfMonth; d.setDate(d.getDate() + 1)) { 
                dataByDay[d.toISOString().split('T')[0]] = { income: 0, expense: 0 }; 
            }
            this.state.transactions
                .filter(t => new Date(t.date + 'T00:00:00').getMonth() === now.getMonth() && 
                             new Date(t.date + 'T00:00:00').getFullYear() === now.getFullYear() && 
                             t.category !== 'Transferência') // Exclui transferências
                .forEach(t => {
                    if(dataByDay[t.date]) {
                        if (t.type === 'income' && t.isPaid) dataByDay[t.date].income += (t.amount || 0);
                        if (t.type === 'expense' && t.isPaid) dataByDay[t.date].expense += (t.amount || 0);
                    }
            });
            const labelsMainOverview = Object.keys(dataByDay).sort(); // Garante ordem cronológica
            this.charts.mainOverviewChart.data.labels = labelsMainOverview;
            this.charts.mainOverviewChart.data.datasets = [ 
                { 
                    label: 'Receitas', 
                    data: labelsMainOverview.map(day => dataByDay[day].income), 
                    backgroundColor: 'rgba(46, 204, 113, 0.7)',
                    borderColor: 'rgba(46, 204, 113, 1)',
                    borderWidth: 1
                }, 
                { 
                    label: 'Despesas Pagas', 
                    data: labelsMainOverview.map(day => dataByDay[day].expense), 
                    backgroundColor: 'rgba(231, 76, 60, 0.7)',
                    borderColor: 'rgba(231, 76, 60, 1)',
                    borderWidth: 1
                } 
            ];
            this.charts.mainOverviewChart.options = { 
                ...commonOptions,
                scales: {
                    x: {
                        ...commonOptions.scales.x,
                        type: 'category', // Gráfico de barras usa 'category' para labels discretas
                        time: { enabled: false } // Desativa o time adapter para 'category'
                    }
                }
            }; // Adapta as opções para barras
            this.charts.mainOverviewChart.update();

            // Dados para o gráfico de Evolução do Patrimônio (Linha)
            const allTransactions = [...this.state.transactions].sort((a,b) => new Date(a.date + 'T00:00:00') - new Date(b.date + 'T00:00:00'));
            const dailyNetWorth = new Map();
            
            // Calcula o patrimônio líquido inicial (saldo de todas as contas que não são cartão de crédito)
            let initialNetWorth = this.state.accounts.reduce((sum, acc) => { 
                return acc.type !== 'credit_card' ? sum + (acc.initialBalance || 0) : sum; 
            }, 0);
            
            if (allTransactions.length === 0) {
                dailyNetWorth.set(new Date().toISOString().split('T')[0], initialNetWorth);
            } else {
                const firstDate = new Date(allTransactions[0].date + 'T00:00:00');
                // Garante que o gráfico comece um dia antes da primeira transação para mostrar o saldo inicial
                firstDate.setDate(firstDate.getDate() - 1); 
                dailyNetWorth.set(firstDate.toISOString().split('T')[0], initialNetWorth);
            }
            
            let runningBalance = initialNetWorth;
            allTransactions.forEach(t => {
                const amount = t.amount || 0;
                const account = this.state.accounts.find(a => a.id === t.accountId);

                // Apenas transações que afetam o patrimônio líquido geral (exclui transferências e gastos/pagamentos de cartão de crédito que são "compensados")
                if (account && t.category !== 'Transferência') {
                    if (account.type !== 'credit_card') { // Contas normais
                        if (t.type === 'income' && t.isPaid) { runningBalance += amount; }
                        if (t.type === 'expense' && t.isPaid) { runningBalance -= amount; }
                    } else { // Cartão de crédito (considera apenas pagamentos da fatura como saída do patrimônio)
                        // A lógica aqui é mais complexa. Um gasto no cartão não diminui o patrimônio até que seja pago.
                        // Um pagamento de fatura, sim, diminui o patrimônio disponível nas outras contas.
                        // Para simplificar no gráfico de patrimônio líquido, focamos no saldo real das contas,
                        // o valor do cartão é uma dívida que já está "embutida" no patrimônio negativo.
                        // O cálculo `acc.currentBalance = balance;` já cuida disso.
                        // Não precisamos ajustar o runningBalance para transações de cartão aqui.
                    }
                }
                // Ajusta para cobrir dias sem transação, mantendo o último saldo
                const currentDate = new Date(t.date + 'T00:00:00');
                let lastDate = Array.from(dailyNetWorth.keys()).pop();
                if (lastDate) {
                    lastDate = new Date(lastDate + 'T00:00:00');
                    // Preenche os dias entre a última transação e a atual
                    let tempDate = new Date(lastDate);
                    tempDate.setDate(tempDate.getDate() + 1); // Começa do dia seguinte à última entrada
                    while (tempDate < currentDate) {
                        dailyNetWorth.set(tempDate.toISOString().split('T')[0], runningBalance);
                        tempDate.setDate(tempDate.getDate() + 1);
                    }
                }
                dailyNetWorth.set(t.date, runningBalance); 
            });

            // Garante que o último dia do período coberto tenha o saldo final
            const todayISO = new Date().toISOString().split('T')[0];
            if (!dailyNetWorth.has(todayISO)) {
                dailyNetWorth.set(todayISO, runningBalance);
            }

            const balanceHistory = Array.from(dailyNetWorth.entries())
                                        .map(([date, value]) => ({ x: date, y: value }))
                                        .sort((a, b) => new Date(a.x) - new Date(b.x));

            this.charts.evolutionChart.data.labels = balanceHistory.map(p => p.x);
            this.charts.evolutionChart.data.datasets = [{
                label: 'Patrimônio Líquido', data: balanceHistory,
                borderColor: document.body.classList.contains('light-mode') ? '#3b82f6' : '#e94560',
                backgroundColor: document.body.classList.contains('light-mode') ? 'rgba(59, 130, 246, 0.1)' : 'rgba(233, 69, 96, 0.1)',
                fill: true, tension: 0.3 // Aumenta a tensão para uma linha mais suave
            }];
            this.charts.evolutionChart.options = { ...commonOptions };
            this.charts.evolutionChart.update();
        },
        exportToCSV() { 
            const filteredTransactions = this.getFilteredTransactions();
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "Tipo,Descrição,Valor,Data,Conta,Categoria,Vencimento,Pago\n"; // Header

            filteredTransactions.forEach(t => {
                const accountName = this.state.accounts.find(acc => acc.id === t.accountId)?.name || 'N/A';
                const row = [
                    t.type === 'income' ? 'Receita' : 'Despesa',
                    `"${t.description.replace(/"/g, '""')}"`, // Handle commas in description
                    t.amount.toFixed(2).replace('.', ','), // Format for BR currency
                    this.formatDate(t.date),
                    `"${accountName.replace(/"/g, '""')}"`,
                    `"${t.category.replace(/"/g, '""')}"`,
                    this.formatDate(t.dueDate),
                    t.isPaid ? 'Sim' : 'Não'
                ].join(',');
                csvContent += row + "\n";
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "transacoes_financeiras.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        },
        exportToPDF() { 
            // Certifique-se de que jspdf e jspdf-autotable estão carregados
            if (typeof window.jspdf === 'undefined' || typeof window.jspdf.AcroForm === 'undefined') {
                alert("As bibliotecas de PDF não foram carregadas corretamente. Por favor, tente novamente.");
                console.error("jsPDF or jspdf-autotable not loaded.");
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            doc.setFontSize(18);
            doc.text("Histórico de Transações", 14, 22);

            const filteredTransactions = this.getFilteredTransactions();
            const tableColumn = ["Tipo", "Descrição", "Valor", "Data", "Conta", "Categoria", "Vencimento", "Pago"];
            const tableRows = [];

            filteredTransactions.forEach(t => {
                const accountName = this.state.accounts.find(acc => acc.id === t.accountId)?.name || 'N/A';
                const transactionData = [
                    t.type === 'income' ? 'Receita' : 'Despesa',
                    t.description,
                    this.formatCurrency(t.amount),
                    this.formatDate(t.date),
                    accountName,
                    t.category,
                    this.formatDate(t.dueDate),
                    t.isPaid ? 'Sim' : 'Não'
                ];
                tableRows.push(transactionData);
            });

            doc.autoTable({
                head: [tableColumn],
                body: tableRows,
                startY: 30,
                headStyles: { fillColor: [233, 69, 96], textColor: 255, fontStyle: 'bold' },
                styles: { fontSize: 8, cellPadding: 3, textColor: '#333' },
                columnStyles: {
                    0: { cellWidth: 20 }, // Tipo
                    1: { cellWidth: 50 }, // Descrição
                    2: { cellWidth: 25, halign: 'right' }, // Valor
                    3: { cellWidth: 20 }, // Data
                    4: { cellWidth: 25 }, // Conta
                    5: { cellWidth: 25 }, // Categoria
                    6: { cellWidth: 20 }, // Vencimento
                    7: { cellWidth: 15, halign: 'center' } // Pago
                },
                didDrawPage: function(data) {
                    // Footer
                    let str = "Página " + doc.internal.getNumberOfPages();
                    doc.setFontSize(10);
                    doc.text(str, data.settings.margin.left, doc.internal.pageSize.height - 10);
                }
            });

            doc.save('transacoes_financeiras.pdf');
        },
    };

    // Reatribuindo as funções para garantir que o 'this' context esteja correto
    Object.keys(financeApp).forEach(key => {
        if (typeof financeApp[key] === 'function') {
            financeApp[key] = financeApp[key].bind(financeApp);
        }
    });

    financeApp.init();
});
</script>

</body>
</html>
